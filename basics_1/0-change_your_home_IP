#!/usr/bin/env bash
# This script modifies the /etc/hosts file by performing robust edits
# to avoid environment-specific issues with 'sed -i'.
# This operation requires root privileges (sudo) to run successfully.

HOSTS_FILE="/etc/hosts"
NEW_LOCALHOST_IP="127.0.0.2"
NEW_LOCALHOST_NAME="localhost"
NEW_FACEBOOK_IP="8.8.8.8"
NEW_FACEBOOK_NAME="facebook.com"

# Create a temporary file to store the modified hosts content
TEMP_FILE=$(mktemp)
if [ ! -f "$TEMP_FILE" ]; then
    echo "Error: Could not create temporary file."
    exit 1
fi

# --- 1. Generate the new content into the temporary file ---

# 1.1. Use a single sed command pipeline to process the file:
# a) Delete any lines that contain the new localhost IP (127.0.0.2) or facebook.com.
# b) For the line starting with 127.0.0.1, remove 'localhost' from it.
# c) Print all remaining lines (all lines except those deleted).
# The output is redirected to the temporary file.
sed "/^${NEW_LOCALHOST_IP}[[:space:]]\+${NEW_LOCALHOST_NAME}/d; /${NEW_FACEBOOK_NAME}/d; /^127\.0\.0\.1/ s/\(\<localhost\>\)\(\s\+\)\?//" "$HOSTS_FILE" > "$TEMP_FILE"

# 1.2. Append the required new entries to the temporary file
# Add the new localhost entry: 127.0.0.2 localhost.
echo -e "${NEW_LOCALHOST_IP}\t${NEW_LOCALHOST_NAME}" >> "$TEMP_FILE"

# Add the new facebook.com entry: 8.8.8.8 facebook.com.
echo -e "${NEW_FACEBOOK_IP}\t${NEW_FACEBOOK_NAME}" >> "$TEMP_FILE"

# --- 2. Replace the original hosts file with the temporary one ---

# This step requires root privileges and performs the actual change.
# We use 'cat' to overwrite the content safely.
if cat "$TEMP_FILE" > "$HOSTS_FILE"; then
    echo "Host resolution updated successfully"
    echo "Please check 'ping localhost' and 'ping facebook.com'."
else
    echo "Error: Failed to overwrite $HOSTS_FILE. You may lack sufficient privileges."
    rm "$TEMP_FILE"
    exit 1
